inherits: ['db.yaml']

global:
    use_schema: True
    name: "health"
    filetype: excel
    sheetname: Indicator Data
    web_paths:
      - url: "https://drive.google.com/uc?export=download&id=0B0fngGlnqNt7UElwVlRjcTctN2c"
        pattern: "adm0_attrs.csv"
      - url: https://drive.google.com/uc?export=download&id=0B0fngGlnqNt7ckZ1XzM5NU9XcUk
        pattern: "*"

    source: "data/health/adm0.csv"
    output: "data/output/health/adm0"
    add_pks: True

    # rename:
      # Survey: year

tables:
  conditions:
    pk: ["year", "geo", "condition", "severity"]
    transform:
      - type: drop
        column: ["Median duration of any breastfeeding"]
      - type: melt
        id_vars: ["Survey", "Country", "Characteristic"]
        var_name: condition
        value_name: proportion_of_children
      - type: filter
        column: Characteristic
        func: eq
        value: Total
      - type: drop
        column: [Characteristic]
      - type: plugin
        func: data_africa.plugins.dhs.set_severity
      - type: plugin
        func: data_africa.plugins.dhs.set_condition
      - type: plugin
        func: data_africa.plugins.dhs.convert_survey
      - type: join
        source: "data/source/attrs/health/geo/adm0_attrs.csv"
        settings:
          usecols: ["adm0_name", "adm0_code"]
        left_on: ["Country"]
        right_on: ["adm0_name"]
      - type: clone
        source: adm0_code
        column: geo
      - type: zfill
        column: geo
        size: 5
      - column: geo
        type: concat_and_fill
        prefix: "040AF"
      - type: drop
        column: [Survey, adm0_name, adm0_code, Country]
      - type: div
        column: proportion_of_children
        value: 100

  conditions_gender:
    pk: ["year", "geo", "condition", "severity", "gender"]
    transform:
      - type: drop
        column: ["Median duration of any breastfeeding"]
      - type: melt
        id_vars: ["Survey", "Country", "Characteristic"]
        var_name: condition
        value_name: proportion_of_children
      - type: filter
        column: Characteristic
        func: isin
        value: ["Sex : Female", "Sex : Male"]
      - type: plugin
        func: data_africa.plugins.dhs.set_severity
      - type: plugin
        func: data_africa.plugins.dhs.set_condition
      - type: plugin
        func: data_africa.plugins.dhs.set_gender
      - type: plugin
        func: data_africa.plugins.dhs.convert_survey
      - type: join
        source: "data/source/attrs/health/geo/adm0_attrs.csv"
        settings:
          usecols: ["adm0_name", "adm0_code"]
        left_on: ["Country"]
        right_on: ["adm0_name"]
      - type: clone
        source: adm0_code
        column: geo
      - type: zfill
        column: geo
        size: 5
      - column: geo
        type: concat_and_fill
        prefix: "040AF"
      - type: div
        column: proportion_of_children
        value: 100
      - type: drop
        column: [Survey, adm0_name, adm0_code, Country, Characteristic]

  conditions_residence:
    pk: ["year", "geo", "condition", "severity", "residence"]
    transform:
      - type: drop
        column: ["Median duration of any breastfeeding"]
      - type: melt
        id_vars: ["Survey", "Country", "Characteristic"]
        var_name: condition
        value_name: proportion_of_children
      - type: filter
        column: Characteristic
        func: isin
        value: ["Residence : Urban", "Residence : Rural"]
      - type: plugin
        func: data_africa.plugins.dhs.set_severity
      - type: plugin
        func: data_africa.plugins.dhs.set_condition
      - type: plugin
        func: data_africa.plugins.dhs.set_residence
      - type: plugin
        func: data_africa.plugins.dhs.convert_survey
      - type: join
        source: "data/source/attrs/health/geo/adm0_attrs.csv"
        settings:
          usecols: ["adm0_name", "adm0_code"]
        left_on: ["Country"]
        right_on: ["adm0_name"]
      - type: clone
        source: adm0_code
        column: geo
      - type: zfill
        column: geo
        size: 5
      - column: geo
        type: concat_and_fill
        prefix: "040AF"
      - type: div
        column: proportion_of_children
        value: 100
      - type: drop
        column: [Survey, adm0_name, adm0_code, Country, Characteristic]
