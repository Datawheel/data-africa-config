inherits: ["db.yaml", "crops/harvest_base.yaml"]

global:
    source : "data/source/data-africa/crops/adm0/<crop>.json"
    output : "data/output/data-africa/crops/adm0/"
    filetype: json
    web_paths:
      - url: "https://drive.google.com/uc?export=download&id=0B0fngGlnqNt7a1U0QTM4RDFIMnM"
        pattern: "adm0_attrs.csv"
      - url: "https://drive.google.com/uc?export=download&id=0B0fngGlnqNt7ZW5lYXRFdC0tWUU"
        pattern: "adm1_attrs.csv"
      - pattern: "*"
        url: "http://hcapi.harvestchoice.org/ocpu/library/hcapi3/R/hcapi/json"
        method: POST
        headers:
          Content-Type: application/json
        payload: "{'var' : ['<crop>_h', '<crop>_i_h', '<crop>_r_h'], 'by' : ['ADM0_NAME']}"


tables:
    harvested_area:
        pk: ["geo"]

        transform:
          - type: agg
            agg: "sum"
            pk: ["ADM0_NAME"]
          - type: drop
            column: ["crop"]
          - type: melt
            id_vars: ["ADM0_NAME"]
            var_name: crop
            value_name: harvested_area
          - type: set_val
            column: year
            value: 2005
          - type: set_val
            column: water_supply
            value: "rainfed"
            where:
              column: crop
              func: str.endswith
              value: "_r_h"
          - type: set_val
            column: water_supply
            value: "irrigated"
            where:
              column: crop
              func: str.endswith
              value: "_i_h"
          - type: set_val
            column: water_supply
            value: "overall"
            where:
              and:
                - column: crop
                  func: ~str.endswith
                  value: "_i_h"
                - column: crop
                  func: ~str.endswith
                  value: "_r_h"
          - type: replace
            column: crop
            target: "_r_h"
            value: ""
          - type: replace
            column: crop
            target: "_i_h"
            value: ""
          - type: replace
            column: crop
            target: "_h"
            value: ""
          - type: join
            source: "data/source/attrs/adm0_attrs.csv"
            settings:
              filetype: csv
              usecols: ["adm0_id", "ADM0_NAME"]
            left_on: ["ADM0_NAME"]
            right_on: ["ADM0_NAME"]
          - type: drop
            column: ["ADM0_NAME"]
          - type: rename
            column: adm0_id
            value: geo
          - type: zfill
            column: geo
            size: 3
          - column: geo
            type: concat_and_fill
            prefix: "040AF"
